name: Lint & Type Check

on:
  push:
    branches: [ main ]
    paths:
      - '**.lua'
      - '.luacheckrc'
      - '.stylua.toml'
      - '.github/workflows/lint-and-type-check.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.lua'
      - '.luacheckrc'
      - '.stylua.toml'
      - '.github/workflows/lint-and-type-check.yml'

jobs:
  lint-lua:
    name: Lua Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Lua and LuaRocks
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1 luarocks

      - name: Install luacheck
        run: |
          sudo luarocks install luacheck

      - name: Run luacheck
        run: |
          luacheck lua/ --config .luacheckrc || true

      - name: Install stylua
        run: |
          cargo install stylua || echo "stylua install failed, will skip format check"

      - name: Check Lua formatting
        run: |
          if command -v stylua &> /dev/null; then
            echo "Checking Lua file formatting..."
            stylua --check lua/ || {
              echo "::error::Lua files are not properly formatted. Run 'stylua lua/' to fix."
              exit 1
            }
          else
            echo "stylua not available, skipping format check"
          fi

      - name: Lint summary
        if: always()
        run: |
          echo "Lua linting and format checking completed"
